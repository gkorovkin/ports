#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

CFLAGS := $(shell dpkg-buildflags --get CFLAGS)
CPPFLAGS := $(shell dpkg-buildflags --get CPPFLAGS)
CXXFLAGS := $(shell dpkg-buildflags --get CXXFLAGS)
LDFLAGS := $(shell dpkg-buildflags --get LDFLAGS)

DEB_BUILD_ARCH ?= $(shell dpkg-architecture -qDEB_BUILD_ARCH)
DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)

#NB: only fixed point variant will comply completly to ITU test vectors, add --enable-fixed-point to use it
CONFIG := --with-pic --libdir=/usr/lib/$(DEB_HOST_MULTIARCH)

ifeq ($(DEB_BUILD_ARCH), amd64)
CPPFLAGS += -march=corei7 -mtune=corei7-avx
CONFIG += --enable-sse --enable-sse2 --enable-sse3 --enable-sse4-1 --enable-sse4-2
# Duplicate these flags in macros because of the bug in the library configuration scripts
CPPFLAGS += -DG722_1_USE_SSE=1 -DG722_1_USE_SSE2=1 -DG722_1_USE_SSE3=1 -DG722_1_USE_SSE4_1=1 -DG722_1_USE_SSE4_2=1
else ifeq ($(DEB_BUILD_ARCH), i386)
CPPFLAGS += -march=corei7 -mtune=corei7-avx
CONFIG += --enable-sse --enable-sse2 --enable-sse3 --enable-sse4-1 --enable-sse4-2
# Duplicate these flags in macros because of the bug in the library configuration scripts
CPPFLAGS += -DG722_1_USE_SSE=1 -DG722_1_USE_SSE2=1 -DG722_1_USE_SSE3=1 -DG722_1_USE_SSE4_1=1 -DG722_1_USE_SSE4_2=1
else ifeq ($(DEB_BUILD_ARCH), x32)
CPPFLAGS += -march=corei7 -mtune=corei7-avx
CONFIG += --enable-sse --enable-sse2 --enable-sse3 --enable-sse4-1 --enable-sse4-2
# Duplicate these flags in macros because of the bug in the library configuration scripts
CPPFLAGS += -DG722_1_USE_SSE=1 -DG722_1_USE_SSE2=1 -DG722_1_USE_SSE3=1 -DG722_1_USE_SSE4_1=1 -DG722_1_USE_SSE4_2=1
else ifneq (,$(findstring mips,$(DEB_HOST_ARCH)))
CPPFLAGS += -mips32r2
endif

CPPFLAGS += -O3 -fno-math-errno -fno-rounding-math -fno-signaling-nans -fno-trapping-math -ftree-vectorize -fgcse-sm -fgcse-las -fgcse-after-reload -floop-interchange -ftree-loop-im -ftree-loop-distribution -ftree-loop-if-convert -funswitch-loops -funroll-loops -frename-registers -fivopts

CXXFLAGS += -std=gnu++11 -fvisibility-inlines-hidden

LDFLAGS += -Wl,-z,relro -Wl,-z,now -Wl,-O1 -Wl,--hash-style=both -Wl,-z,noexecstack

export CFLAGS
export CPPFLAGS
export CXXFLAGS
export LDFLAGS

-include ../version

../version:
	debian/get-git-source.sh

%:
	dh $@ --with autoreconf

override_dh_auto_configure:
	dh_auto_configure -- $(CONFIG)

override_dh_clean:
	dh_clean config.log src/dct4.h
